## Observing NATed packets

We plan to analyze the IP header of packets that are generated by the `red`, `green` and `blue` hosts and destined to a network on the Internet. For this we use the `tcpdump` capture utility.

On `red` we start the ping command to `8.8.8.8`:

```shell-session
root@red:~# ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_req=1 ttl=127 time=42.0 ms
[...]
```

:::note
When running the `tcpdump` command the sequence to follow is:
- Run the `tcpdump` command with the corresponding options in a terminal, starting packet capture. The `tcpdump` utility now waits for packets to be transmitted on the interfaces it is listening on.
- In another terminal run a specific network client command that generates traffic.
- Return to the terminal running the `tcpdump` command and watch for captured packets.
- When you no longer need the `tcpdump` utility, stop capturing packets using the Ctrl+c key combination.
:::

To capture traffic, on the host station we run the command

```shell-session
root@host:~# tcpdump -n -i eth0 ip dst host 8.8.8.8
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes
12:59:20.976707 IP host > 8.8.8.8: ICMP echo request, id 625, seq 6, length 64
12:59:21.977708 IP host > 8.8.8.8: ICMP echo request, id 625, seq 7, length 64
```

We notice that the source IP address is `host` even though it is the `red` host that executes the ping command and generates the ICMP echo request packets.

To see the packets as originally generated, we run the `tcpdump` command on the `usernet` interface instead of `eth0`:

```shell-session
root@host:~# tcpdump -n -i usernet ip dst host 8.8.8.8
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on usernet, link-type EN10MB (Ethernet), capture size 65535 bytes
13:01:12.557692 IP red > 8.8.8.8: ICMP echo request, id 626, seq 6, length 64
13:01:13.559726 IP red > 8.8.8.8: ICMP echo request, id 626, seq 7, length 64
```

To see how traffic is translated we capture traffic on all interfaces (the ones of interest are usernet and eth0)

```shell-session
root@host:~# tcpdump -n -i any ip dst host 8.8.8.8
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes
10:23:07.632412 IP red > 8.8.8.8: ICMP echo request, id 707, seq 237, length 64
10:23:07.632430 IP host > 8.8.8.8: ICMP echo request, id 707, seq 237, length 64
10:23:08.633936 IP red > 8.8.8.8: ICMP echo request, id 707, seq 238, length 64
10:23:08.633954 IP host > 8.8.8.8: ICMP echo request, id 707, seq 238, length 64
```

In the above list we notice both packets that are captured on the `usernet` interface (generated by the `red` host) and those captured on the `eth0` interface (forwarded by the `host`).

Also capture the reply packets, which have as their source address `8.8.8.8`. Use the `ip src host 8.8.8.8` argument string for `tcpdump`.

Repeat the above tests for the `green` host.
